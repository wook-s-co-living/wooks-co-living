{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %} markets_detail {% endblock title %}

{% block header %}
  <script src="{% static 'owlcarousel/jquery.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'owlcarousel/owl.carousel.css' %}">
  <link rel="stylesheet" href="{% static 'owlcarousel/owl.theme.default.min.css' %}">
  <script src="{% static 'owlcarousel/owl.carousel.js' %}"></script>

  <link rel="stylesheet" href="{% static 'css/markets_detail.css' %}">
{% endblock header %}

{% block content %}

  <div class='markets--detail'>
    <section class='markets--detail--container'>
      <div class='markets--carousel--dblock'>
        <div class="owl-carousel owl-theme">
          {% for postimage in post.postimages.all %}
            <button class='item owl--carousel--item' value="{{ forloop.counter }}">
              <img src="{{ postimage.image.url }}" alt="{{ post.title }}">
            </button>
          {% endfor %}
        </div>
        <a class="owl--carousel--back" href="{% url 'markets:index' %}">
          <i class="bi bi-chevron-left"></i>
        </a>

        <button class='owl--carousel--share'>
          <i class="bi bi-share"></i>
        </button>

        <div class='owl--carousel--collapse d-none'>
          <button id='owl--carousel--collapse--url'>
            <i class="bi bi-cloud-arrow-up-fill"></i> <span>URL</span>
          </button>

          <a href="https://twitter.com/intent/tweet?text=í˜¼ê±°ë™ë½_{{ post.title }}&url=http://127.0.0.1:8000/markets/{{ post.pk }}/" data-toggle="tooltip" data-placement="top" title="" target="_blank" rel="noopener" aria-label="Twitter" data-original-title="Twitter">
            <i class="bi bi-twitter"></i> <span>Twitter</span>
          </a>

          <a id="kakaotalk-sharing-btn" href="javascript:shareMessage()">
            <i class="bi bi-chat-fill"></i> <span>KaKao</span>
          </a>
        </div>
      </div>

      <div class='markets--carousel--dnone d-none'>
        <div class="owl-carousel owl-theme">
          {% for postimage in post.postimages.all %}
            <button class='item owl--carousel--item' value="{{ forloop.counter }}">
              <img src="{{ postimage.image_first.url }}" alt="{{ post.title }}">
            </button>
          {% endfor %}
        </div>

        <button class='owl--carousel--close'>
          <i class="bi bi-x"></i>
        </button>
      </div>

      {% comment %} ë””í…Œì¼ í—¤ë” {% endcomment %}
      <a class='markets--detail--header' href="{% url 'accounts:profile' post.user.username %}">
        <div class='markets--detail--header--left'>
          <header>
            {% if post.user.image %}
              <img src="{{ post.user.image.url }}" alt="{{ post.user }}">
            {% else %}
              <img src="{% static 'image/noimage.png' %}" alt="noimage">
            {% endif %}
          </header>

          <div>
            <h1>{{ post.user.first_name }}</h1>

            <h2>{{ post.user.town }} {{ post.user.building }}</h2>
          </div>
        </div>

        <div class='markets--detail--header--right'>
          <h1>{{ post.user.maum }}cm</h1>

          <h2>
            <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" style="width: {{ post.user.maum }}%"></div>
            </div>
          </h2>

          <h3 id='markets--detail--header--info'>ë§ˆìŒê±°ë¦¬ <i class="bi bi-info-circle"></i></h3>

          <div class='markets--detail--header--infobox d-none'>
            <span>ë§ˆìŒê±°ë¦¬ë€?</span><br><br>
            ê°€ê¹Œìš¸ìˆ˜ë¡<br>
            ë§¤ë„ˆê°€<br>
            ì¢‹ì•„ìš”!
          </div>
        </div>
      </a>

      <section class='markets--detail--section'>
        <h1>{{ post.title }}</h1>

        <h2>
          {% if post.price %}
            ì¤‘ê³ <span>&nbsp;Â·&nbsp;</span>{{ post.created_time }}
          {% else %}
            ë‚˜ëˆ”<span>&nbsp;Â·&nbsp;</span>{{ post.created_time }}
          {% endif %}
        </h2>

        <h4>{{ post.content|linebreaksbr }}</h4>

        <div class="markets--detail--info">
          <div>
            <h5>ê´€ì‹¬ <span id='markets--detail--section-likecount'>{{ post.like_users.count }}</span><span>&nbsp;Â·&nbsp;</span>ì±„íŒ… ??<span>&nbsp;Â·&nbsp;</span>ì¡°íšŒ {{ post.views }}</h5>
          </div>
          {% if request.user == post.user %}
            <div>
              <h5><a href="{% url 'markets:update' post.pk %}" style="margin-right:8px;">ìˆ˜ì •</a> <a href="{% url 'markets:delete' post.pk %}"  onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a></h5>
            </div>
          {% endif %}
        </div>
      </section>

      {% comment %} ë””í…Œì¼ í‘¸í„° {% endcomment %}
      <footer class='markets--detail--footer'>
        <h1 class='markets--detail--footer--title'>{{ post.user.first_name }}ë‹˜ì˜ íŒë§¤ìƒí’ˆ</h1>

        <section class='markets--detail--footer-section'>
          {% for user_post in user_posts %}
            <a class='markets--detail--footer-section--item' href="{% url 'markets:detail' user_post.pk %}">
              <header>
                <img src="{{ user_post.postimages.first.image.url }}" alt="{{ user_post.user.username }}">
              </header>

              <section>
                <h1>{{ user_post.title }}</h1>

                <h2>
                  {% if user_post.price %}
                    {{ user_post.price|intcomma }}ì›
                  {% else %}
                    ë¬´ë£Œ ë‚˜ëˆ”
                  {% endif %}
                </h2>

                <h3>{{ user_post.user.town }} {{ user_post.user.building }}</h3>

                <h4>ê´€ì‹¬ {{ user_post.like_users.count }}<span>&nbsp;Â·&nbsp;</span>ì¡°íšŒ {{ user_post.views }}</h4>
              </section>
            </a>
          {% empty %}
            <div class='markets--detail--footer--empty'>
              {{ post.user.first_name }}ë‹˜ì˜ ë‹¤ë¥¸ íŒë§¤ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¥
            </div>
          {% endfor %}
        </section>
      </footer>

      {% comment %} ì•Œë¦¼ì°½ {% endcomment %}
      <div id='markets--detail--alert' style='display: none;'>
        <h1>ê´€ì‹¬ëª©ë¡ì— ì¶”ê°€ëì–´ìš”.</h1>
        
        <a href="{% url 'accounts:profile' request.user.username %}?cate=markets">ê´€ì‹¬ëª©ë¡ë³´ê¸°</a>
      </div>

      {% comment %} í•˜ë‹¨ ë„¤ë¹„ë°” {% endcomment %}
      <nav class='markets--detail--navbar'>
        <div class='markets--detail--navbar--left'>
          <form id='markets--detail--like--form' data-post-id="{{ post.pk }}">
            {% csrf_token %}
            {% if request.user not in post.like_users.all %}
              <button type='submit'>
                <i class="bi bi-heart"></i>
              </button>
            {% else %}
              <button type='submit'>
                <i class="bi bi-heart-fill"></i>
              </button>
            {% endif %}
          </form>
  
          <div>
            {% if post.price %}
              {{ post.price|intcomma }}ì›
            {% else %}
              ë¬´ë£Œ ë‚˜ëˆ”
            {% endif %}
          </div>
        </div>

        <a class='markets--detail--navbar--right' href="{% url 'chats:room' post.user.username %}">
          ì±„íŒ…í•˜ê¸°
        </a>
      </nav>

    </section>
  </div>

  <script>
    $('.owl-carousel').owlCarousel({
        startPosition: false,
        loop:true,
        margin:10,
        responsiveClass:true,
        responsive:{
            0:{
                items:1,
                nav:false,
                loop:false
            },
            600:{
                items:1,
                nav:false,
                loop:false
            },
            1000:{
                items:1,
                nav:false,
                loop:false
            }
        }
    })
  </script>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.2.0/kakao.min.js"
  integrity="sha384-x+WG2i7pOR+oWb6O5GV5f1KN2Ko6N7PTGPS7UlasYWNxZMKQA63Cj/B2lbUmUfuC" crossorigin="anonymous"></script>
  <script>
    Kakao.init('{{ KAKAO_JS_KEY }}'); // ì‚¬ìš©í•˜ë ¤ëŠ” ì•±ì˜ JavaScript í‚¤ ì…ë ¥
  </script>
  <script>
    function shareMessage() {
      Kakao.Share.sendDefault({
        objectType: 'feed',
        content: {
          title: '{{ post.title }}',
          description: 'í”Œë¦¬ë§ˆì¼“',
          imageUrl: 'https://1.bp.blogspot.com/-mJ5jFeNA4gQ/X79hVOtDv8I/AAAAAAAAQYk/p5C-cInqnT8mIJ_i5BNNwKcCBh-1P1UOACLcBGAsYHQ/s625-rw/money%2Brain.jpg',
          link: {
            // [ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜] > [í”Œë«í¼] ì—ì„œ ë“±ë¡í•œ ì‚¬ì´íŠ¸ ë„ë©”ì¸ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
            webUrl: 'http://127.0.0.1:8000/',
          },
        },
        social: {
          likeCount: {{ post.like_users.count }},
        },
        buttons: [
          {
            title: 'ì›¹ìœ¼ë¡œ ë³´ê¸°',
            link: {
              webUrl: 'http://127.0.0.1:8000/markets/{{ post.pk }}/',
            },
          },
        ],
      });
    }
  </script>
{% endblock content %}

{% block script %}
  <script src="{% static 'js/markets_detail.js' %}"></script>
{% endblock script %}